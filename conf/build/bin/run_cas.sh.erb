#!/bin/bash

ulimit -n 98304
ulimit -n
sysctl -w net.ipv4.tcp_tw_recycle=1
sysctl -w net.ipv4.tcp_fin_timeout=2
sysctl -w net.ipv4.tcp_tw_reuse=1
DC_NAME=`facter| grep 'colo =>'|awk '{print $3}'`
MEM_SIZE=`facter| grep 'memorysize =>'|awk '{print $3}'`
echo $MEM_SIZE
JMX_MEM=`echo "$MEM_SIZE 10.0" | awk '{if ($1 > $2) print "8192M" ; else print "2048M"}'`
echo $DC_NAME
DC_ID=`grep $DC_NAME: /opt/mkhoj/conf/dc_info/dc_info.cfg  |awk -F':' '{print $2}'`
DC_NAME=`grep $DC_NAME /opt/mkhoj/conf/dc_info/dc_info.cfg  |awk -F':' '{print $1}'`
if [ $DC_ID > 0 ]
then
    echo $DC_ID
    echo $DC_NAME
  exec /usr/lib/jvm/java7/bin/java -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9004 -Duser.timezone=UTC\
 -Ddc.id=$DC_ID -Ddc.name=$DC_NAME -Dhost.name=$(hostname) -Drun.environment=prod\
 -Djava.security.properties=/opt/mkhoj/conf/cas/java.security\
 -Djava.net.preferIPv4Stack=true\
 -Dcom.sun.management.jmxremote.local.only=false\
 -Dcom.sun.management.jmxremote.authenticate=false\
 -Dcom.sun.management.jmxremote.ssl=false\
 -Djava.rmi.server.hostname=$(hostname)\
 -Dio.netty.noResourceLeakDetection -server -Xms$JMX_MEM -Xmx$JMX_MEM -XX:CMSInitiatingOccupancyFraction=65 -XX:+UseCMSInitiatingOccupancyOnly -XX:+UseConcMarkSweepGC -XX:NewRatio=4 -XX:SurvivorRatio=6\
 -jar /opt/inmobi/cas/webapps/cas.jar
else
     echo "Invalid dc_id"
     exit
fi
